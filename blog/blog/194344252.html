<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>ActiveMQ简述及实例</title><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- top1 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-3347102627476643"
     data-ad-slot="2352128818"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></head><body><h1>ActiveMQ简述及实例</h1><div><p><strong>1.JMS介绍</strong> <br>
&nbsp;&nbsp;&nbsp;  JMS源于企业应用对于消息中间件的需求，使应用程序可以通过消息进行异步处理而互不影响。Sun公司和它的合作伙伴设计的JMS API定义了一组公共的应用程序接口和相应语法，使得Java程序能够和其他消息组件进行通信。JMS有四个组成部分：JMS服务提供者、消息管理对象、消息的生产者消费者和消息本身。 <br>
1)JMS服务提供者实现消息队列和通知，同时实现消息管理的API。JMS已经是J2EE API的一部分，J2EE服务器都提供JMS服务。 <br>
2) 消息管理对象提供对消息进行操作的API。JMS API中有两个消息管理对象：创建jms连接使用的工厂（ConnectionFactory）和目的地（Destination），根据消息的消费方式的不同ConnectionFactory可以分为QueueConnectionFactory和TopicConnectionFactory，目的地（Destination）可以分为队列（Queue）和主题（Topic）两种。 <br>
3)消息的生产者和消费者。消息的产生由JMS的客户端完成，JMS服务提供者负责管理这些消息，消息的消费者可以接收消息。消息的生产者可以分为――点对点消息发布者（P2P）和主题消息发布者（TopicPublisher）。所以，消息的消费者分为两类：主题消息的订阅者（TopicSubscriber)和点对点消息的接收者（queue receiver） <br>
4)消息。消息是服务提供者和客户端之间传递信息所使用的信息单元。JMS消息由以下三部分组成： <br>
　　消息头（header）――JMS消息头包含了许多字段，它们是消息发送后由JMS提供者或消息发送者产生，用来表示消息、设置优先权和失效时间等等，并且为消息确定路由。 <br>
　　属性（property）――用来添加删除消息头以外的附加信息。 <br>
　　消息体（body）――JMS中定义了5种消息体：ByteMessage、MapMessage、ObjectMessage、StreamMessage和TextMessage。 <br>
<br>
<strong>2.Messages 通信方式 <br>
</strong>上面提到JMS通信方式分为点对点通信和发布/订阅方式 <br>
1)点对点方式（point-to-point） <br>
&nbsp;&nbsp;  点对点的消息发送方式主要建立在 Message Queue,Sender,reciever上，Message Queue 存贮消息，Sneder 发送消息，receive接收消息.具体点就是Sender Client发送Message Queue ,而 receiver Cliernt从Queue中接收消息和&quot;发送消息已接受&quot;到Quere,确认消息接收。消息发送客户端与接收客户端没有时间上的依赖，发送客户端可以在任何时刻发送信息到Queue，而不需要知道接收客户端是不是在运行 <br>
2)发布/订阅 方式（publish/subscriber Messaging） <br>
&nbsp;&nbsp;&nbsp;  发布/订阅方式用于多接收客户端的方式.作为发布订阅的方式，可能存在多个接收客户端，并且接收端客户端与发送客户端存在时间上的依赖。一个接收端只能接收他创建以后发送客户端发送的信息。作为subscriber ,在接收消息时有两种方法，destination的receive方法，和实现message listener 接口的onMessage 方法。 <br>
<br>
<strong>3.为什么选用ActiveMQ</strong> <br>
&nbsp;&nbsp;  1）ActiveMQ是一个开放源码 <br>
&nbsp;&nbsp;  2）基于Apache 2.0 licenced 发布并实现了JMS 1.1。 <br>
&nbsp;&nbsp;  3）ActiveMQ现在已经和作为很多项目的异步消息通信核心了 <br>
&nbsp;&nbsp;  4）在很多中小型项目中采用ActiveMQ+SPRING+TOMCAT开发模式。 <br>
<br>
<strong>4.编程模式</strong> <br>
4.1消息产生者向JMS发送消息的步骤 <br>
(1)创建连接使用的工厂类JMS ConnectionFactory <br>
(2)使用管理对象JMS ConnectionFactory建立连接Connection <br>
(3)使用连接Connection 建立会话Session <br>
(4)使用会话Session和管理对象Destination创建消息生产者MessageSender <br>
(5)使用消息生产者MessageSender发送消息 <br>
4.2消息消费者从JMS接受消息的步骤 <br>
(1)创建连接使用的工厂类JMS ConnectionFactory <br>
(2)使用管理对象JMS ConnectionFactory建立连接Connection <br>
(3)使用连接Connection 建立会话Session <br>
(4)使用会话Session和管理对象Destination创建消息消费者MessageReceiver <br>
(5)使用消息消费者MessageReceiver接受消息，需要用setMessageListener将MessageListener接口绑定到MessageReceiver <br>
消息消费者必须实现了MessageListener接口，需要定义onMessage事件方法。 <br>
<br>
<strong>5.ActiveMQ运行</strong> <br>
ActiveMQ5.0版本默认启动时，启动了内置的jetty服务器，提供一个demo应用和用于监控ActiveMQ的admin应用。运行%activemq_home%bin/目录下的 activemq.bat , 之后你会看见如下一段话表示启动成功。 <br>
打开http://localhost:8161/admin/queues.jsp ，可以查看相应的queue中是否有消息 <br>
<br>
<br>
<strong>6.SendMessage(用于发送消息) <br>
</strong></p>
<div class="bar">
<div class="tools">Java代码</div>
</div>
<div class="dp-highlighter">
<ol class="dp-j">
    <li><span><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.Connection; &nbsp;&nbsp;</span></span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.Destination; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.JMSException; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.MessageProducer; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.Session; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.TextMessage; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> org.apache.activemq.ActiveMQConnectionFactory; &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">public</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">class</font></strong></span><span> SendMessage { &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">private</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">static</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">final</font></strong></span><span> String url =</span><span class="string"><font color="#0000ff">&quot;tcp://localhost:61616&quot;</font></span><span>; &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">private</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">static</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">final</font></strong></span><span> String QUEUE_NAME =</span><span class="string"><font color="#0000ff">&quot;choice.queue&quot;</font></span><span>; &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">protected</font></strong></span><span> String expectedBody = </span><span class="string"><font color="#0000ff">&quot;&lt;hello&gt;world!&lt;/hello&gt;&quot;</font></span><span>; &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">public</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">void</font></strong></span><span> sendMessage() </span><span class="keyword"><strong><font color="#7f0055">throws</font></strong></span><span> JMSException{ &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; Connection connection =</span><span class="keyword"><strong><font color="#7f0055">null</font></strong></span><span>; &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">try</font></strong></span><span>{ &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; ActiveMQConnectionFactory connectionFactory =</span><span class="keyword"><strong><font color="#7f0055">new</font></strong></span><span> ActiveMQConnectionFactory(url); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; connection = (Connection)connectionFactory.createConnection(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; connection.start(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; Session session = (Session)connection.createSession(</span><span class="keyword"><strong><font color="#7f0055">false</font></strong></span><span>, Session.AUTO_ACKNOWLEDGE); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; Destination destination = session.createQueue(QUEUE_NAME); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; MessageProducer producer = session.createProducer(destination); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; TextMessage message = session.createTextMessage(expectedBody); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; message.setStringProperty(</span><span class="string"><font color="#0000ff">&quot;headname&quot;</font></span><span>, </span><span class="string"><font color="#0000ff">&quot;remoteB&quot;</font></span><span>); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; producer.send(message);&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; }</span><span class="keyword"><strong><font color="#7f0055">catch</font></strong></span><span>(Exception e){ &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; e.printStackTrace(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span> } &nbsp;&nbsp;</span></li>
    <li><span>  &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">public</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">static</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">void</font></strong></span><span> main(String[] args){ &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; SendMessage sndMsg = </span><span class="keyword"><strong><font color="#7f0055">new</font></strong></span><span> SendMessage(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">try</font></strong></span><span>{ &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; sndMsg.sendMessage(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; }</span><span class="keyword"><strong><font color="#7f0055">catch</font></strong></span><span>(Exception ex){ &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; System.out.println(ex.toString()); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span> } &nbsp;&nbsp;</span></li>
    <li><span>}&nbsp;&nbsp;</span></li>
</ol>
</div>
<p> </p>
<p><strong>7.ReceiveMessage(用于接收消息)</strong></p>
<div class="dp-highlighter">
<div class="bar">
<div class="tools">Java代码</div>
</div>
<ol class="dp-j">
    <li><span><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> java.io.File; &nbsp;&nbsp;</span></span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> java.io.FileInputStream; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> java.io.FileOutputStream; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> java.io.IOException; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.BytesMessage; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.Connection; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.Destination; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.JMSException; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.Message; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.MessageConsumer; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.Session; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> javax.jms.TextMessage; &nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">import</font></strong></span><span> org.apache.activemq.ActiveMQConnectionFactory; &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span></li>
    <li><span class="keyword"><strong><font color="#7f0055">public</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">class</font></strong></span><span> ReceiveMessage { &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">private</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">static</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">final</font></strong></span><span> String url = </span><span class="string"><font color="#0000ff">&quot;tcp://localhost:61616&quot;</font></span><span>; &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">private</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">static</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">final</font></strong></span><span> String QUEUE_NAME = </span><span class="string"><font color="#0000ff">&quot;choice.queue&quot;</font></span><span>; &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">public</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">void</font></strong></span><span> receiveMessage() { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; Connection connection = </span><span class="keyword"><strong><font color="#7f0055">null</font></strong></span><span>; &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">try</font></strong></span><span> { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">try</font></strong></span><span> { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; ActiveMQConnectionFactory connectionFactory = </span><span class="keyword"><strong><font color="#7f0055">new</font></strong></span><span> ActiveMQConnectionFactory(url); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; connection = connectionFactory.createConnection(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; } </span><span class="keyword"><strong><font color="#7f0055">catch</font></strong></span><span> (Exception e) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(e.toString()); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; connection.start(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; Session session = connection.createSession(</span><span class="keyword"><strong><font color="#7f0055">false</font></strong></span><span>, &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Session.AUTO_ACKNOWLEDGE); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; Destination destination = session.createQueue(QUEUE_NAME); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; MessageConsumer consumer = session.createConsumer(destination); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; consumeMessagesAndClose(connection, session, consumer); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; } </span><span class="keyword"><strong><font color="#7f0055">catch</font></strong></span><span> (Exception e) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(e.toString()); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span> } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">protected</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">void</font></strong></span><span> consumeMessagesAndClose(Connection connection,Session session, MessageConsumer consumer) &nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">throws</font></strong></span><span> JMSException { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">for</font></strong></span><span> (</span><span class="keyword"><strong><font color="#7f0055">int</font></strong></span><span> i = </span><span class="number"><font color="#c00000">0</font></span><span>; i &lt; </span><span class="number"><font color="#c00000">1</font></span><span>;) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; Message message = consumer.receive(</span><span class="number"><font color="#c00000">1000</font></span><span>); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">if</font></strong></span><span> (message != </span><span class="keyword"><strong><font color="#7f0055">null</font></strong></span><span>) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; i++; &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; onMessage(message); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; System.out.println(</span><span class="string"><font color="#0000ff">&quot;Closing connection&quot;</font></span><span>); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; consumer.close(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; session.close(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; connection.close(); &nbsp;&nbsp;</span></li>
    <li><span> } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">public</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">void</font></strong></span><span> onMessage(Message message) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">try</font></strong></span><span> { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;</span><span class="keyword"><strong><font color="#7f0055">if</font></strong></span><span> (message </span><span class="keyword"><strong><font color="#7f0055">instanceof</font></strong></span><span> TextMessage) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; TextMessage txtMsg = (TextMessage) message; &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; String msg = txtMsg.getText(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(</span><span class="string"><font color="#0000ff">&quot;Received: &quot;</font></span><span> + msg); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; } </span><span class="keyword"><strong><font color="#7f0055">catch</font></strong></span><span> (Exception e) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;&nbsp; e.printStackTrace(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span></li>
    <li><span> } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span></li>
    <li><span> </span><span class="keyword"><strong><font color="#7f0055">public</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">static</font></strong></span><span> </span><span class="keyword"><strong><font color="#7f0055">void</font></strong></span><span> main(String args[]) { &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; ReceiveMessage rm = </span><span class="keyword"><strong><font color="#7f0055">new</font></strong></span><span> ReceiveMessage(); &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp; rm.receiveMessage(); &nbsp;&nbsp;</span></li>
    <li><span> } &nbsp;&nbsp;</span></li>
    <li><span>&nbsp;&nbsp;</span></li>
    <li><span>}&nbsp;&nbsp;</span></li>
</ol>
</div></div></body></html>