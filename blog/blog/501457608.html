<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>PHP、css、js文件的bom头问题</title></head><body><h1>PHP、css、js文件的bom头问题</h1><div><p>事情的起源是一段很普通的代码：</p><div><div><div></div></div><ol><li><span><span>&lt;?php&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>session_start();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span></span><span>$_SESSION</span><span>[</span><span>'test'</span><span>]&nbsp;=&nbsp;</span><span>'test'</span><span>;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span></span><span>$_SESSION</span><span>[</span><span>'name'</span><span>]&nbsp;=&nbsp;</span><span>'name'</span><span>;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span></span><span>$data</span><span>&nbsp;=&nbsp;serialize(</span><span>$_SESSION</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>...更多后续代码&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>?&gt;&nbsp;&nbsp;</span></li></ol></div><p>&lt;?phpsession_start(); $_SESSION['test'] = 'test';$_SESSION['name'] = 'name'; $data = serialize($_SESSION);...更多后续代码?&gt;<br /><br /></p><p>没有问题，很简单的一段设置session的代码。</p><p>但是运行后却报错：</p><p>Cannot send session cache limiter - headers already sent (output started at...) on line ...</p><p>报错信息很明显，就是在session_start()之前有了输出，导致后面的header发送失败。</p><p>因为很多情况下&lt;?php&nbsp; 标签之前空格也会被当做header发送出去的，所以先检查这个。</p><p>仔细检查一下，没有空格，没有echo ,没有print等导致输出的问题，那么到底是什么问题呢？</p><p>应该有很多人都想到了，bom头。</p><p>对，这里就是bom头搞的鬼。</p><p>那么什么是bom头呢？</p><p></p><pre><div><div></div></div><ol><li><span><span>BOM:&nbsp;Byte&nbsp;Order&nbsp;Mark&nbsp;&nbsp;</span></span><li><span>就是一个字节顺序标签，类似一个标记，又叫签名，&nbsp;&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span><li><span>BOM签名的意思就是告诉编辑器当前文件采用何种编码,方便编辑器识别,但是BOM虽然在编辑器中不显示,但是会产生输出,就像多了一个空行。&nbsp;&nbsp;</span><li><span>一般的编码集中并不会出现bom头，unicode编码集中会出现。&nbsp;&nbsp;</span><li><span>常见的bom头是：【摘录自：http://www.cnblogs.com/chengmo/archive/2010/10/30/1864004.html】&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;UTF-8&nbsp;&nbsp;&nbsp;&nbsp;║&nbsp;EF&nbsp;BB&nbsp;BF&nbsp;&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;UTF-16LE&nbsp;║&nbsp;FF&nbsp;FE&nbsp;(小尾）&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;UTF-16BE&nbsp;║&nbsp;FE&nbsp;FF&nbsp;（大尾）&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;UTF-32LE&nbsp;║&nbsp;FF&nbsp;FE&nbsp;00&nbsp;00&nbsp;&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;UTF-32BE&nbsp;║&nbsp;00&nbsp;00&nbsp;FE&nbsp;FF&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span><li><span>为什么bom头会产生乱码？&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ol><p>&nbsp;</p><ol><li><span>&nbsp;&nbsp;</span><li><span>有bom头的存储或者字节流，它一定是unicode字符集编码。到底属于那一种（utf-8还是utf-16或是utf-32)，通过头可以判断出来。&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span><li><span>由于已经说过utf-16,utf-32不指定bom头，解析程序默认就认为是ansi编码，出现乱码。而utf-8指定或者不指定程序都可判断知道对于的字符集编码。&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span><li><span>问题就出在这里，可能有的应用程序（ie6浏览器），它就认为如果utf-8编码，就不需要指定bom头，它可以自己判断，相反指定了bom头，它还会出现问题&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span><li><span>（因为它把头当utf-8解析出现乱码了）。这里不截图了，cnblogs里面谈这个比较多，目前ie6会出现问题。其它ie7+,firefox,chrome不会出现，会忽略掉bom头。&nbsp;&nbsp;</span><li><span>&nbsp;&nbsp;</span><li><span>统一解决办法是：存为utf-8编码是，不需要加入bom头，其它utf-16,utf-32加入。&nbsp;</span></li></li></li></li></li></li></li></li></li></li></ol></pre><p><br />另摘录一个网上找来的去除bom头的代码：</p><p></p><div><div><div></div></div><ol><li><span><span>&lt;?php&nbsp;&nbsp;</span></span></li><li><span></span><span>if</span><span>&nbsp;(isset(</span><span>$_GET</span><span>[</span><span>'dir'</span><span>])){</span><span>//config&nbsp;the&nbsp;basedir </span><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$basedir</span><span>=</span><span>$_GET</span><span>[</span><span>'dir'</span><span>];&nbsp;&nbsp;</span></li><li><span>}</span><span>else</span><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$basedir</span><span>=&nbsp;</span><span>'.'</span><span>;&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span></span><span>$auto</span><span>&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>checkdir(</span><span>$basedir</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span></span><span>function</span><span>&nbsp;checkdir(</span><span>$basedir</span><span>){&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>$dh</span><span>&nbsp;=&nbsp;opendir(</span><span>$basedir</span><span>))&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>while</span><span>((</span><span>$file</span><span>&nbsp;=&nbsp;readdir(</span><span>$dh</span><span>))&nbsp;!==&nbsp;false)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>$file</span><span>&nbsp;!=&nbsp;</span><span>'.'</span><span>&nbsp;&amp;&amp;&nbsp;</span><span>$file</span><span>!=&nbsp;</span><span>'..'</span><span>){&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(!</span><span>is_dir</span><span>(</span><span>$basedir</span><span>.</span><span>&quot;/&quot;</span><span>.</span><span>$file</span><span>))&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>echo</span><span>&quot;filename:&nbsp;$basedir/$file&quot;</span><span>.checkBOM(</span><span>&quot;$basedir/$file&quot;</span><span>).</span><span>&quot;&lt;br&gt;&quot;</span><span>;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span>else</span><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$dirname</span><span>=&nbsp;</span><span>$basedir</span><span>.</span><span>&quot;/&quot;</span><span>.</span><span>$file</span><span>;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkdir(</span><span>$dirname</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>closedir</span><span>(</span><span>$dh</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span></span><span>function</span><span>&nbsp;checkBOM&nbsp;(</span><span>$filename</span><span>)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>global</span><span>$auto</span><span>;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$contents</span><span>=&nbsp;</span><span>file_get_contents</span><span>(</span><span>$filename</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$charset</span><span>[1]&nbsp;=</span><span>substr</span><span>(</span><span>$contents</span><span>,&nbsp;0,&nbsp;1);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$charset</span><span>[2]&nbsp;=</span><span>substr</span><span>(</span><span>$contents</span><span>,&nbsp;1,&nbsp;1);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$charset</span><span>[3]&nbsp;=</span><span>substr</span><span>(</span><span>$contents</span><span>,&nbsp;2,&nbsp;1);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(ord(</span><span>$charset</span><span>[1])&nbsp;==&nbsp;239&nbsp;&amp;&amp;&nbsp;ord(</span><span>$charset</span><span>[2])&nbsp;==&nbsp;187&nbsp;&amp;&amp;ord(</span><span>$charset</span><span>[3])&nbsp;==&nbsp;191)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>$auto</span><span>&nbsp;==&nbsp;1)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$rest</span><span>=&nbsp;</span><span>substr</span><span>(</span><span>$contents</span><span>,&nbsp;3);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;(</span><span>$filename</span><span>,</span><span>$rest</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span>(</span><span>&quot;&lt;font&nbsp;color=red&gt;BOM&nbsp;found,automatically&nbsp;removed.&lt;/font&gt;&quot;</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span>else</span><span>&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span>(</span><span>&quot;&lt;font&nbsp;color=red&gt;BOM&nbsp;found.&lt;/font&gt;&quot;</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;elsereturn&nbsp;(</span><span>&quot;BOM&nbsp;Not&nbsp;Found.&quot;</span><span>);&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span></span><span>function</span><span>&nbsp;rewrite&nbsp;(</span><span>$filename</span><span>,</span><span>$data</span><span>)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>$filenum</span><span>=&nbsp;</span><span>fopen</span><span>(</span><span>$filename</span><span>,</span><span>&quot;w&quot;</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flock</span><span>(</span><span>$filenum</span><span>,&nbsp;LOCK_EX);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;fwrite(</span><span>$filenum</span><span>,</span><span>$data</span><span>);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;fclose(</span><span>$filenum</span><span>);&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>?&gt;&nbsp;&nbsp;</span></li></ol></div><p>另外一个常见的bom头的地方时xml文件。解析失败的话，有很大一部分原因是这个。</p><p>Error on line 1 of document&nbsp; : Content is not allowed in prolog. Nested exception: Content is not allowed in prolog.</p></div></body></html>